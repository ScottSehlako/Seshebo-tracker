import 'package:flutter/material.dart';
import '../db/db_helper.dart';
import '../models/stock.dart';

class StockScreen extends StatefulWidget {
  const StockScreen({super.key});

  @override
  State<StockScreen> createState() => _StockScreenState();
}

class _StockScreenState extends State<StockScreen> {
  final DBHelper _dbHelper = DBHelper();
  final TextEditingController _searchController = TextEditingController();

  List<StockModel> _allStock = [];
  List<StockModel> _visibleStock = [];
  String _filterType = 'All';

  @override
  void initState() {
    super.initState();
    _fetchStock();
    _searchController.addListener(_applyFilters);
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  /// Fetch all stock items from DB
  Future<void> _fetchStock() async {
    final db = await _dbHelper.database;
    final result = await db.query('stock', orderBy: 'meat_type ASC');

    setState(() {
      _allStock = result.map((e) => StockModel.fromMap(e)).toList();
      _applyFilters();
    });
  }

  /// Apply search and filter conditions
  void _applyFilters() {
    final query = _searchController.text.trim().toLowerCase();

    setState(() {
      _visibleStock = _allStock.where((item) {
        final matchesSearch = item.type.toLowerCase().contains(query);
        final isLow = item.quantityRemaining <= item.lowStockThreshold;

        if (_filterType == 'Low Stock') {
          return matchesSearch && isLow;
        }
        return matchesSearch;
      }).toList();
    });
  }

  /// Show dialog for add/edit stock
  Future<void> _showStockDialog({StockModel? existing}) async {
    final isEditing = existing != null;

    final typeCtrl = TextEditingController(text: existing?.type ?? '');
    final totalCtrl =
        TextEditingController(text: existing?.quantityTotal.toString() ?? '');
    final remainCtrl = TextEditingController(
        text: existing?.quantityRemaining.toString() ?? '');
    final priceCtrl =
        TextEditingController(text: existing?.pricePerUnit.toString() ?? '');
    final thresholdCtrl = TextEditingController(
        text: existing?.lowStockThreshold.toString() ?? '5');

    await showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text(isEditing ? 'Edit Stock Item' : 'Add Stock Item'),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              _buildTextField('Meat Type', typeCtrl),
              const SizedBox(height: 10),
              _buildTextField('Total Quantity', totalCtrl, isNumber: true),
              const SizedBox(height: 10),
              _buildTextField('Remaining Quantity', remainCtrl, isNumber: true),
              const SizedBox(height: 10),
              _buildTextField('Price per Unit (R)', priceCtrl, isNumber: true),
              const SizedBox(height: 10),
              _buildTextField('Low Stock Threshold', thresholdCtrl, isNumber: true),
            ],
          ),
        ),
        actions: [
          TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('Cancel')),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.blue),
            onPressed: () async {
              final type = typeCtrl.text.trim();
              if (type.isEmpty) return;

              final total = int.tryParse(totalCtrl.text) ?? 0;
              final remain = int.tryParse(remainCtrl.text) ?? 0;
              final price = double.tryParse(priceCtrl.text) ?? 0.0;
              final threshold = int.tryParse(thresholdCtrl.text) ?? 5;

              // Validate that remaining doesn't exceed total
              if (remain > total) {
                if (context.mounted) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Remaining quantity cannot exceed total quantity'),
                      backgroundColor: Colors.red,
                    ),
                  );
                }
                return;
              }

              final stock = StockModel(
                id: existing?.id,
                type: type,
                quantityTotal: total,
                quantityRemaining: remain,
                pricePerUnit: price,
                lowStockThreshold: threshold,
              );

              if (isEditing) {
                await _dbHelper.update('stock', stock.toMap(), 'id = ?', [existing!.id]);
              } else {
                await _dbHelper.insert('stock', stock.toMap());
              }

              if (context.mounted) Navigator.pop(context);
              await _fetchStock();
            },
            child: const Text('Save', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  /// Delete a stock item
  Future<void> _deleteStock(int id) async {
    final confirm = await showDialog<bool>(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text('Confirm Delete'),
        content: const Text('Are you sure you want to delete this item?'),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text('Cancel')),
          ElevatedButton(
              style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
              onPressed: () => Navigator.pop(context, true),
              child: const Text('Delete')),
        ],
      ),
    );

    if (confirm == true) {
      await _dbHelper.delete('stock', 'id = ?', [id]);
      await _fetchStock();
    }
  }

  Widget _buildTextField(String label, TextEditingController controller,
      {bool isNumber = false}) {
    return TextField(
      controller: controller,
      keyboardType: isNumber ? TextInputType.number : TextInputType.text,
      decoration: InputDecoration(
        labelText: label,
        border: const OutlineInputBorder(),
        contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      ),
    );
  }

  Widget _buildSearchAndFilterBar() {
    return Container(
      color: Colors.grey[200],
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
      child: Row(
        children: [
          Expanded(
            child: TextField(
              controller: _searchController,
              decoration: InputDecoration(
                hintText: 'Search stock...',
                prefixIcon: const Icon(Icons.search),
                filled: true,
                fillColor: Colors.white,
                border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(10),
                    borderSide: BorderSide.none),
              ),
            ),
          ),
          const SizedBox(width: 10),
          DropdownButton<String>(
            value: _filterType,
            underline: const SizedBox(),
            items: const [
              DropdownMenuItem(value: 'All', child: Text('All')),
              DropdownMenuItem(value: 'Low Stock', child: Text('Low Stock')),
            ],
            onChanged: (val) {
              setState(() {
                _filterType = val!;
                _applyFilters();
              });
            },
          ),
        ],
      ),
    );
  }

  Widget _buildStockCard(StockModel stock) {
    final isLow = stock.quantityRemaining <= stock.lowStockThreshold;

    return Card(
      margin: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
      elevation: 2,
      child: ListTile(
        title: Text(
          stock.type,
          style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
        ),
        subtitle: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Total: ${stock.quantityTotal}'),
            Text(
              'Remaining: ${stock.quantityRemaining}',
              style: TextStyle(
                color: isLow ? Colors.red : Colors.black,
                fontWeight: isLow ? FontWeight.bold : FontWeight.normal,
              ),
            ),
            Text('Price: R${stock.pricePerUnit.toStringAsFixed(2)}/unit'),
            if (isLow)
              Text(
                'LOW STOCK! (Threshold: ${stock.lowStockThreshold})',
                style: const TextStyle(
                  color: Colors.red,
                  fontWeight: FontWeight.bold,
                  fontSize: 12,
                ),
              ),
          ],
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            IconButton(
                icon: const Icon(Icons.edit, color: Colors.blue),
                onPressed: () => _showStockDialog(existing: stock)),
            IconButton(
                icon: const Icon(Icons.delete, color: Colors.red),
                onPressed: () => _deleteStock(stock.id!)),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey[100],
      appBar: AppBar(
        title: const Text('Stock Management'),
        backgroundColor: Colors.blue,
        foregroundColor: Colors.white,
      ),
      body: Column(
        children: [
          _buildSearchAndFilterBar(),
          Expanded(
            child: _visibleStock.isEmpty
                ? const Center(child: Text('No stock available'))
                : ListView.builder(
                    itemCount: _visibleStock.length,
                    itemBuilder: (context, i) => _buildStockCard(_visibleStock[i]),
                  ),
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        backgroundColor: Colors.blue,
        onPressed: () => _showStockDialog(),
        child: const Icon(Icons.add, color: Colors.white),
      ),
    );
  }
}